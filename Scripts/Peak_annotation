#Load required packages
library("ChIPpeakAnno")
library("GenomicRanges")
library("org.At.tair.db")
library("TxDb.Athaliana.BioMart.plantsmart28")
library("biomaRt")

#Set work directory

#Annotate the peaks via ChIPpeakAnno
##Prepare annotation data with toGRanges
annoData <- toGRanges(TxDb.Athaliana.BioMart.plantsmart28, feature="gene")
annoData

##Convert the peak data to GRanges with toGRanges
ABF1_ABA <- toGRanges('./ABF1_ABA_optimal_narrowPeak_p16.bed', format = 'BED', header = F)

##Keep the seqnames in the same style
seqlevelsStyle(annoData) <- seqlevelsStyle(ABF1_ABA)
annoData

##Annotate the peaks with annotatePeakInBatch---Do annotation by nearest TSS
ABF1_ABA_annot <- annotatePeakInBatch(ABF1_ABA, AnnotationData=annoData, featureType = "TSS",output="nearestLocation", PeakLocForDistance = "start")

##Pie chart to demonstrate the overlap features of the peaks
pie(table(ABF1_ABA_annot$insideFeature))


ensembl <- useMart(biomart = "plants_mart",
                     dataset = "athaliana_eg_gene",
                     host = "plants.ensembl.org")

annot <- addGeneIDs(annot, mart = ensembl, feature_id_type = "ensembl_gene_id",
                      IDs2Add = c("entrezgene", "tair_symbol", "description"))

seqlevelsStyle(TxDb.Athaliana.BioMart.plantsmart28) <- seqlevelsStyle(gr)

aCR<-assignChromosomeRegion(gr, nucleotideLevel=FALSE, 
                           precedence=c("Promoters", "immediateDownstream", 
                                         "fiveUTRs", "threeUTRs", 
                                         "Exons", "Introns"), 
                           TxDb=TxDb.Athaliana.BioMart.plantsmart28)
barplot(aCR$percentage)

##Write out the annotation results
write.table(ABF1_ABA_annot, file = './ABF1_ABA_annotated.csv', sep = ",", col.names = T, row.names = F, quote = F)

